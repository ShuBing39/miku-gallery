import axios from 'axios';
import * as cheerio from 'cheerio';
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv'; 

dotenv.config();

const SUPABASE_URL = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

// ğŸ”‘ ä½ çš„ç®¡ç†å‘˜ ID (ä»åˆšæ‰çš„ä¿®å¤è„šæœ¬é‡Œæ‹¿æ¥çš„)
// è¿™æ ·çˆ¬ä¸‹æ¥çš„å•†å“ä¼šè‡ªåŠ¨å½’å±åˆ°ä½ çš„åä¸‹ï¼Œæ–¹ä¾¿ç®¡ç†
const ADMIN_USER_ID = '13483eb4-8d32-4b7c-84d3-2d7b3f8abe04'; 

if (!SUPABASE_KEY) {
  console.error("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° Keyï¼è¯·ç¡®è®¤ .env é‡Œæœ‰ SUPABASE_SERVICE_KEY");
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const MM_GOODS_URL = 'https://magicalmirai.com/2025/goods.html'; 

// â³ å»¶æ—¶å‡½æ•°ï¼Œé˜²æ­¢è¯·æ±‚å¤ªå¿«è¢«å° IP
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function scrapeMagicalMirai() {
  console.log(`\nğŸš€ å¯åŠ¨ã€é­”æ³•æœªæ¥ 2025ã€‘ä¸“ç”¨çˆ¬è™«...`);
  console.log(`ğŸ”— ç›®æ ‡ç½‘å€: ${MM_GOODS_URL}`);

  try {
    // ä¼ªè£…æˆæµè§ˆå™¨
    const headers = {
      'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8'
    };

    const response = await axios.get(MM_GOODS_URL, { headers });
    const $ = cheerio.load(response.data);
    
    // ğŸ“¦ ç­–ç•¥ï¼šé­”æ³•æœªæ¥å®˜ç½‘é€šå¸¸ç”¨ grid å¸ƒå±€ï¼Œæˆ‘ä»¬å¯»æ‰¾åŒ…å«â€œä»·æ ¼â€å’Œâ€œå›¾ç‰‡â€çš„å®¹å™¨
    const itemsFound = [];
    
    // éå†æ‰€æœ‰å›¾ç‰‡ï¼Œå‘ä¸ŠæŸ¥æ‰¾çˆ¶å®¹å™¨
    $('img').each((i, img) => {
      const $img = $(img);
      const src = $img.attr('src');
      
      // è¿‡æ»¤æ‰å¯¼èˆªæ å›¾æ ‡ã€Logoç­‰æ— å…³å›¾ç‰‡
      if (!src || src.match(/(logo|icon|banner|nav|footer|header|btn)/i)) return;

      // å‘ä¸Šå¯»æ‰¾åŒ…å«ä»·æ ¼ä¿¡æ¯çš„çˆ¶çº§ (å°è¯•æ‰¾ 3 å±‚)
      const $parent = $img.closest('div, li, dd, td');
      const text = $parent.text().trim();
      
      // å¿…é¡»åŒ…å«ä»·æ ¼ç¬¦å· (Â¥ æˆ– å††) æˆ–è€…æ˜¯ Price å•è¯
      if (text.match(/(Â¥|å††|Price|PRICE)/)) {
        
        // 1. æå–åç§° (é€šå¸¸åœ¨ h3, h4, strong, .name, .title').first().text().trim();
        let name = $parent.find('h3, h4, strong, .name, .title').first().text().trim();
        if (!name) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
            if (lines.length > 0) name = lines[0];
        }
        if (!name) name = 'é­”æ³•æœªæ¥2025å‘¨è¾¹';
        if (name.length > 60) name = name.substring(0, 60) + '...';

        // 2. è¡¥å…¨å›¾ç‰‡é“¾æ¥
        let fullImage = src;
        if (!src.startsWith('http')) {
          const baseUrlObj = new URL(MM_GOODS_URL);
          fullImage = new URL(src, baseUrlObj.href).href;
        }

        // 3. æå–ä»·æ ¼
        let price = 0;
        const priceMatch = text.match(/([0-9,]+)\s*(?:å††|Â¥)/);
        if (priceMatch) {
            price = parseInt(priceMatch[1].replace(/,/g, ''));
        }

        // 4. æŸ¥é‡å¹¶æ·»åŠ 
        if (!itemsFound.some(it => it.image_url === fullImage)) {
           itemsFound.push({
             name: name,
             image_url: fullImage,
             price: price,
             link: MM_GOODS_URL,
             category: 'é­”æ³•æœªæ¥',
             author: 'Magical Mirai Official', // è¿™é‡Œçš„ author æ˜¯æ˜¾ç¤ºçš„æ–‡å­—ä½œè€…
             status: 'approved',
             release_date: new Date().toISOString().split('T')[0],
             
             // âœ… [æ–°å¢ 1] æ˜ç¡®æ ‡è®°ä¸ºå®˜æ–¹åˆ¶å“ (é˜²æ­¢æ··å…¥åŒäººåŒº)
             is_fan_work: false, 
             
             // âœ… [æ–°å¢ 2] ç»‘å®šåˆ°ç®¡ç†å‘˜ ID (é˜²æ­¢æˆä¸ºæ— ä¸»æ•°æ®)
             user_id: ADMIN_USER_ID,
             
             is_ai: false
           });
        }
      }
    });

    console.log(`ğŸ“¦ æ‰«æåˆ° ${itemsFound.length} ä¸ªæ½œåœ¨å•†å“ï¼Œå¼€å§‹å…¥åº“...`);

    if (itemsFound.length === 0) {
        console.warn("âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°å•†å“ã€‚å¯èƒ½æ˜¯å®˜ç½‘é¡µé¢ç»“æ„è¿˜æ²¡æ›´æ–°ï¼Œæˆ–è€…è¿˜æ²¡å‘å¸ƒå•†å“åˆ—è¡¨ã€‚");
    }

    for (const item of itemsFound) {
      // æŸ¥é‡ï¼šç”¨å›¾ç‰‡é“¾æ¥æŸ¥é‡
      const { data: existing } = await supabase.from('items').select('id').eq('image_url', item.image_url).single();

      if (existing) {
        process.stdout.write('.'); // å·²å­˜åœ¨
      } else {
        const { error } = await supabase.from('items').insert([item]);
        if (error) console.error(`âŒ å…¥åº“å¤±è´¥: ${error.message}`);
        else process.stdout.write('âœ¨');
      }
      await sleep(100); 
    }
    console.log('\nâœ… é­”æ³•æœªæ¥å•†å“æŠ“å–å®Œæˆï¼');

  } catch (err) {
    console.error(`âŒ æŠ“å–å¤±è´¥: ${err.message}`);
    if (err.response && err.response.status === 404) {
        console.error("ğŸ‘‰ åŸå› ï¼šç½‘å€ 404ï¼Œè¯·ç¡®è®¤ goods.html é¡µé¢æ˜¯å¦å·²ç»ä¸Šçº¿ã€‚");
    }
  }
}

scrapeMagicalMirai();